<html>
<head>
    <title>Captcha</title>
    <script type="text/javascript">
        function scale(tries) {
            
            console.log("scale " + tries)
            const frameContainer = document.body.children[2].children[1];
            const scale = (document.body.clientWidth-26) / frameContainer.clientWidth;
            
            if(scale < 1 && tries > 0) {
                scale(tries-1)
            }
            const frameHeight = frameContainer.clientHeight;
            const frameScaledHeight = frameContainer.clientHeight*scale;
                
            if(scale > 1 && frameScaledHeight < document.body.clientHeight) {
                frameContainer.style['scale'] = scale;
            }
                
            const frameTop = frameHeight * (scale - 1) * 0.5;
            const framePadding = (document.body.clientHeight - frameScaledHeight)/2;
                        
            frameContainer.style['top'] = frameTop + framePadding
        }
        function onIframeLoad(tries) {
            if(tries === 0)
                return;
            try {
                    const frameContainer = document.body.children[2].children[1];
                    const iframe = frameContainer.children[0];
                    iframe.addEventListener("load", function() {
                        
                        console.log("load " + tries)
                        scale(10);
                    });
            } catch (e) {
                console.log(e);
                setTimeout(function () {
                    onIframeLoad(tries-1);
                }, 500);
            }
        }
        function onSubmit(token) {
            console.log(token);
            window.location.replace(window.origin + "/submit?token=" + token);
        }

        function onloadCallback() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const key = urlParams.get('key') ?? "xxx"
            const size = urlParams.get('size') ?? "normal"

            grecaptcha.render('my_captcha', {
              'sitekey' : key,
              'callback' : onSubmit,
              'size': size
            });

            if(size == 'invisible') {
                grecaptcha.execute();
                onIframeLoad(10);
            }
        };
    </script>
    <style>
        .container {
          height: 100%;
          position: relative;
        }
    </style>
</head>
<body>
    <div id="my_captcha" class="container"></div>
    <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit"
            async defer>
    </script>
</body>
</html>
